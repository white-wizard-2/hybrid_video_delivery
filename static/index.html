<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CDN vs Proxy Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .log-entry {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .service-card {
            transition: all 0.3s ease;
        }
        .service-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .metric-card-proxy {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">
                <i class="fas fa-network-wired text-blue-600"></i>
                CDN vs Proxy Demo
            </h1>
            <p class="text-gray-600 text-lg">Real-time comparison of CDN and Proxy streaming with Raptor FEC and FLUTE delivery</p>
        </header>

        <!-- Control Panel -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">
                <i class="fas fa-sliders-h text-blue-600"></i>
                Control Panel
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- CDN Controls -->
                <div class="border-l-4 border-blue-500 pl-4">
                    <h3 class="text-xl font-semibold text-blue-600 mb-3">CDN Service</h3>
                    <div class="space-y-3">
                        <button @click="addCDNNode" 
                                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-plus mr-2"></i>Add CDN Node
                        </button>
                        <div v-if="cdnNodes.length > 0" class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">Add Client to CDN Node:</label>
                            <select v-model="selectedCDNNode" class="w-full p-2 border border-gray-300 rounded-lg">
                                <option v-for="node in cdnNodes" :key="node.ID" :value="node.ID">
                                    {{ node.ID }}
                                </option>
                            </select>
                            <button @click="addCDNClient" 
                                    :disabled="!selectedCDNNode"
                                    class="bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white px-4 py-2 rounded-lg transition-colors">
                                <i class="fas fa-user-plus mr-2"></i>Add Client
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Proxy Controls -->
                <div class="border-l-4 border-purple-500 pl-4">
                    <h3 class="text-xl font-semibold text-purple-600 mb-3">Proxy Service (5G + FLUTE)</h3>
                    <div class="space-y-3">
                        <button @click="addProxyNode" 
                                class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-plus mr-2"></i>Add Proxy Node
                        </button>
                        <div v-if="proxyNodes.length > 0" class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">Add Client to Proxy Node:</label>
                            <select v-model="selectedProxyNode" class="w-full p-2 border border-gray-300 rounded-lg">
                                <option v-for="node in proxyNodes" :key="node.ID" :value="node.ID">
                                    {{ node.ID }}
                                </option>
                            </select>
                            <button @click="addProxyClient" 
                                    :disabled="!selectedProxyNode"
                                    class="bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white px-4 py-2 rounded-lg transition-colors">
                                <i class="fas fa-user-plus mr-2"></i>Add Client
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Packet Drop Configuration -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h3 class="text-lg font-semibold mb-4 text-gray-800">Packet Drop Configuration</h3>
            
            <div class="space-y-4">
                <!-- Enable Packet Drop -->
                <div class="flex items-center justify-between">
                    <label class="text-sm font-medium text-gray-700">Enable Packet Drop</label>
                    <input type="checkbox" v-model="packetDropConfig.enabled" @change="updatePacketDropConfig" 
                           class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                </div>
                
                <!-- Packet Drop Rate -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Packet Drop Rate: {{ packetDropConfig.dropRate }}%
                    </label>
                    <input type="range" v-model="packetDropConfig.dropRate" min="0" max="50" step="1" 
                           @input="updatePacketDropConfig"
                           class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider">
                </div>
                
                        <!-- FEC Recovery -->
                        <div class="flex items-center justify-between">
                            <label class="text-sm font-medium text-gray-700">FEC Recovery (Always Enabled)</label>
                            <div class="text-xs text-gray-500">Maximum recovery (20 repair symbols)</div>
                        </div>
            </div>
        </div>

        <!-- Statistics Comparison -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- CDN Stats -->
            <div class="service-card bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-2xl font-semibold text-blue-600 mb-4">
                    <i class="fas fa-server mr-2"></i>CDN Statistics
                </h3>
                <div class="grid grid-cols-2 gap-4">
                    <div class="metric-card text-white p-4 rounded-lg">
                        <div class="text-2xl font-bold">{{ cdnStats.nodeCount || 0 }}</div>
                        <div class="text-sm opacity-90">Nodes</div>
                    </div>
                    <div class="metric-card text-white p-4 rounded-lg">
                        <div class="text-2xl font-bold">{{ cdnStats.clientCount || 0 }}</div>
                        <div class="text-sm opacity-90">Clients</div>
                    </div>
                    <div class="metric-card text-white p-4 rounded-lg">
                        <div class="text-2xl font-bold">{{ cdnStats.latency || 0 }}ms</div>
                        <div class="text-sm opacity-90">Latency</div>
                    </div>
                    <div class="metric-card text-white p-4 rounded-lg">
                        <div class="text-2xl font-bold">{{ cdnStats.bandwidth || 0 }}Mbps</div>
                        <div class="text-sm opacity-90">Bandwidth</div>
                    </div>
                </div>
                
                
                <!-- Unicast Bandwidth Distribution -->
                <div class="mt-4 p-4 bg-blue-50 rounded-lg">
                    <h4 class="text-lg font-semibold text-blue-700 mb-3">
                        <i class="fas fa-chart-pie mr-2"></i>Bandwidth Distribution
                    </h4>
                    <div class="grid grid-cols-1 gap-4 mb-3">
                        <div class="text-center">
                            <div class="text-xl font-bold text-blue-600">{{ cdnStats.bandwidth || 0 }} Mbps</div>
                            <div class="text-sm text-gray-600">Unicast (100%)</div>
                        </div>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div class="bg-blue-600 h-3 rounded-full" style="width: 100%"></div>
                    </div>
                </div>
                
                <!-- Unicast Statistics -->
                <div class="mt-4 p-4 bg-green-50 rounded-lg">
                    <h4 class="text-lg font-semibold text-green-700 mb-3">
                        <i class="fas fa-network-wired mr-2"></i>Unicast Statistics
                    </h4>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="font-medium">Unicast Bytes:</span>
                            <span class="text-green-600">{{ (cdnStats.unicastBytes || 0).toLocaleString() }}</span>
                        </div>
                        <div>
                            <span class="font-medium">Total Chunks:</span>
                            <span class="text-green-600">{{ cdnStats.totalChunks || 0 }}</span>
                        </div>
                        <div>
                            <span class="font-medium">Avg Chunk Size:</span>
                            <span class="text-green-600">{{ cdnStats.avgChunkSize || 0 }} bytes</span>
                        </div>
                        <div>
                            <span class="font-medium">Recovery Rate:</span>
                            <span class="text-green-600">{{ cdnStats.recoveryRate || 0 }}%</span>
                        </div>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-gray-700">Packet Loss</span>
                        <span class="text-sm font-medium text-gray-700">{{ cdnStats.packetLoss || 0 }}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-600 h-2 rounded-full" :style="{ width: (cdnStats.packetLoss || 0) + '%' }"></div>
                    </div>
                </div>
            </div>

            <!-- Proxy Stats -->
            <div class="service-card bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-2xl font-semibold text-purple-600 mb-4">
                    <i class="fas fa-broadcast-tower mr-2"></i>Proxy Statistics (5G + FLUTE)
                </h3>
                <div class="grid grid-cols-2 gap-4">
                    <div class="metric-card-proxy text-white p-4 rounded-lg">
                        <div class="text-2xl font-bold">{{ proxyStats.nodeCount || 0 }}</div>
                        <div class="text-sm opacity-90">Nodes</div>
                    </div>
                    <div class="metric-card-proxy text-white p-4 rounded-lg">
                        <div class="text-2xl font-bold">{{ proxyStats.clientCount || 0 }}</div>
                        <div class="text-sm opacity-90">Clients</div>
                    </div>
                    <div class="metric-card-proxy text-white p-4 rounded-lg">
                        <div class="text-2xl font-bold">{{ proxyStats.latency || 0 }}ms</div>
                        <div class="text-sm opacity-90">Latency</div>
                    </div>
                    <div class="metric-card-proxy text-white p-4 rounded-lg">
                        <div class="text-2xl font-bold">{{ proxyStats.bandwidth || 0 }}Mbps</div>
                        <div class="text-sm opacity-90">Total Bandwidth</div>
                    </div>
                </div>
                
                <!-- Unicast vs Broadcast Bandwidth Split -->
                <div class="mt-4 p-4 bg-purple-50 rounded-lg">
                    <h4 class="text-lg font-semibold text-purple-700 mb-3">
                        <i class="fas fa-chart-pie mr-2"></i>Bandwidth Distribution
                    </h4>
                    <div class="grid grid-cols-2 gap-4 mb-3">
                        <div class="text-center">
                            <div class="text-xl font-bold text-blue-600">{{ proxyStats.unicastBandwidth || 0 }} Mbps</div>
                            <div class="text-sm text-gray-600">Unicast ({{ proxyStats.unicastPercent || 0 }}%)</div>
                        </div>
                        <div class="text-center">
                            <div class="text-xl font-bold text-green-600">{{ proxyStats.broadcastBandwidth || 0 }} Mbps</div>
                            <div class="text-sm text-gray-600">Broadcast ({{ proxyStats.broadcastPercent || 0 }}%)</div>
                        </div>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div class="bg-blue-600 h-3 rounded-l-full" :style="{ width: (proxyStats.unicastPercent || 0) + '%' }"></div>
                        <div class="bg-green-600 h-3 rounded-r-full" :style="{ width: (proxyStats.broadcastPercent || 0) + '%' }"></div>
                    </div>
                </div>
                
                <!-- FLUTE Statistics -->
                <div class="mt-4 p-4 bg-blue-50 rounded-lg" v-if="proxyStats.fluteStats">
                    <h4 class="text-lg font-semibold text-blue-700 mb-3">
                        <i class="fas fa-satellite mr-2"></i>FLUTE Multicast Stats
                    </h4>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="font-medium">Multicast Sessions:</span>
                            <span class="text-blue-600">{{ proxyStats.fluteStats.multicastSessions || 0 }}</span>
                        </div>
                        <div>
                            <span class="font-medium">FLUTE Packets:</span>
                            <span class="text-blue-600">{{ proxyStats.fluteStats.flutePackets || 0 }}</span>
                        </div>
                        <div>
                            <span class="font-medium">Unicast Bytes:</span>
                            <span class="text-blue-600">{{ (proxyStats.fluteStats.unicastBytes || 0).toLocaleString() }}</span>
                        </div>
                        <div>
                            <span class="font-medium">Broadcast Bytes:</span>
                            <span class="text-blue-600">{{ (proxyStats.fluteStats.broadcastBytes || 0).toLocaleString() }}</span>
                        </div>
                    </div>
                    
                    <!-- FEC and Fallback Statistics -->
                    <div class="mt-4 pt-4 border-t border-blue-200">
                        <h5 class="text-md font-semibold text-blue-600 mb-2">
                            <i class="fas fa-shield-alt mr-2"></i>FEC & Fallback Stats
                        </h5>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="font-medium">FEC Successes:</span>
                                <span class="text-green-600">{{ proxyStats.fluteStats?.fecSuccesses || 0 }}</span>
                            </div>
                            <div>
                                <span class="font-medium">FEC Failures:</span>
                                <span class="text-red-600">{{ proxyStats.fluteStats?.fecFailures || 0 }}</span>
                            </div>
                            <div>
                                <span class="font-medium">Unicast Fallbacks:</span>
                                <span class="text-orange-600">{{ proxyStats.fluteStats?.unicastFallbacks || 0 }}</span>
                            </div>
                            <div>
                                <span class="font-medium">Recovery Rate:</span>
                                <span class="text-blue-600">{{ proxyStats.recoveryRate || 0 }}%</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-gray-700">Packet Loss (with Raptor FEC)</span>
                        <span class="text-sm font-medium text-gray-700">{{ proxyStats.packetLoss || 0 }}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-purple-600 h-2 rounded-full" :style="{ width: (proxyStats.packetLoss || 0) + '%' }"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Real-time Logs -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-semibold text-gray-800">
                    <i class="fas fa-terminal text-green-600"></i>
                    Real-time Logs
                </h3>
                <div class="flex space-x-2">
                    <button @click="clearLogs" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
                        <i class="fas fa-trash mr-1"></i>Clear
                    </button>
                    <button @click="toggleAutoScroll" :class="autoScroll ? 'bg-green-600' : 'bg-gray-600'" class="text-white px-3 py-1 rounded text-sm">
                        <i class="fas fa-scroll mr-1"></i>{{ autoScroll ? 'Auto-scroll ON' : 'Auto-scroll OFF' }}
                    </button>
                </div>
            </div>
            <div class="bg-gray-900 text-green-400 p-4 rounded-lg h-96 overflow-y-auto font-mono text-sm" ref="logContainer">
                <div v-for="log in logs" :key="log.timestamp" 
                     :class="getLogClass(log.level)"
                     class="log-entry mb-1">
                    <span class="text-gray-500">[{{ formatTime(log.timestamp) }}]</span>
                    <span :class="getServiceClass(log.service)" class="font-bold">[{{ log.service }}]</span>
                    <span :class="getLevelClass(log.level)" class="font-bold">[{{ log.level }}]</span>
                    <span class="text-white">{{ log.message }}</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Check if Vue is loaded
        if (typeof Vue === 'undefined') {
            console.error('Vue.js is not loaded!');
            document.body.innerHTML = '<div style="padding: 20px; color: red;"><h1>Error: Vue.js failed to load</h1><p>Please check your internet connection and refresh the page.</p></div>';
        } else {
            console.log('Vue.js loaded successfully');
            
            // Simple Vue app for testing
            const { createApp } = Vue;
            
            createApp({
                data() {
                    return {
                        cdnNodes: [],
                        proxyNodes: [],
                        selectedCDNNode: '',
                        selectedProxyNode: '',
                        cdnStats: { nodeCount: 0, clientCount: 0, latency: 50, packetLoss: 0.1, bandwidth: 100 },
                        proxyStats: { nodeCount: 0, clientCount: 0, latency: 20, packetLoss: 2.0, bandwidth: 200 },
                        logs: [],
                        autoScroll: true,
                        ws: null,
                        packetDropConfig: {
                            enabled: false,
                            dropRate: 0
                        }
                    };
                },
                mounted() {
                    console.log('Vue app mounted');
                    this.loadData();
                    this.loadStats();
                    this.connectWebSocket();
                    // Refresh data every 2 seconds
                    setInterval(() => {
                        this.loadData();
                        this.loadStats();
                    }, 2000);
                },
                methods: {
                    async loadData() {
                        try {
                            const [cdnNodes, proxyNodes] = await Promise.all([
                                fetch('/api/cdn/nodes').then(r => r.json()),
                                fetch('/api/proxy/nodes').then(r => r.json())
                            ]);
                            // Convert object to array format
                            this.cdnNodes = Object.values(cdnNodes).map(node => ({
                                ID: node.ID,
                                Clients: Object.values(node.Clients || {})
                            }));
                            this.proxyNodes = Object.values(proxyNodes).map(node => ({
                                ID: node.ID,
                                Clients: Object.values(node.Clients || {})
                            }));
                            console.log('Data loaded:', this.cdnNodes, this.proxyNodes);
                        } catch (error) {
                            console.error('Failed to load data:', error);
                        }
                    },
                    async loadStats() {
                        try {
                            const [cdnStats, proxyStats] = await Promise.all([
                                fetch('/api/cdn/stats').then(r => r.json()),
                                fetch('/api/proxy/stats').then(r => r.json())
                            ]);
                            this.cdnStats = cdnStats;
                            this.proxyStats = proxyStats;
                            console.log('Stats loaded:', cdnStats, proxyStats);
                        } catch (error) {
                            console.error('Failed to load stats:', error);
                        }
                    },
                    connectWebSocket() {
                        try {
                            this.ws = new WebSocket(`ws://${window.location.host}/ws`);
                            this.ws.onmessage = (event) => {
                                const log = JSON.parse(event.data);
                                this.logs.push(log);
                                if (this.logs.length > 1000) {
                                    this.logs.shift(); // Keep only last 1000 logs
                                }
                                if (this.autoScroll) {
                                    this.$nextTick(() => {
                                        const container = this.$refs.logContainer;
                                        if (container) {
                                            container.scrollTop = container.scrollHeight;
                                        }
                                    });
                                }
                            };
                            this.ws.onerror = (error) => {
                                console.error('WebSocket error:', error);
                            };
                            this.ws.onclose = () => {
                                console.log('WebSocket closed, reconnecting...');
                                setTimeout(() => this.connectWebSocket(), 5000);
                            };
                        } catch (error) {
                            console.error('Failed to connect WebSocket:', error);
                        }
                    },
                    async addCDNNode() {
                        try {
                            const response = await fetch('/api/cdn/nodes', { method: 'POST' });
                            const result = await response.json();
                            console.log('Added CDN node:', result);
                            await Promise.all([this.loadData(), this.loadStats()]);
                        } catch (error) {
                            console.error('Failed to add CDN node:', error);
                        }
                    },
                    async addProxyNode() {
                        try {
                            const response = await fetch('/api/proxy/nodes', { method: 'POST' });
                            const result = await response.json();
                            console.log('Added Proxy node:', result);
                            await Promise.all([this.loadData(), this.loadStats()]);
                        } catch (error) {
                            console.error('Failed to add Proxy node:', error);
                        }
                    },
                    async addCDNClient() {
                        if (!this.selectedCDNNode) return;
                        try {
                            const response = await fetch(`/api/cdn/nodes/${this.selectedCDNNode}/clients`, { method: 'POST' });
                            const result = await response.json();
                            console.log('Added CDN client:', result);
                            await Promise.all([this.loadData(), this.loadStats()]);
                        } catch (error) {
                            console.error('Failed to add CDN client:', error);
                        }
                    },
                    async addProxyClient() {
                        if (!this.selectedProxyNode) return;
                        try {
                            const response = await fetch(`/api/proxy/nodes/${this.selectedProxyNode}/clients`, { method: 'POST' });
                            const result = await response.json();
                            console.log('Added Proxy client:', result);
                            await Promise.all([this.loadData(), this.loadStats()]);
                        } catch (error) {
                            console.error('Failed to add Proxy client:', error);
                        }
                    },
                    clearLogs() {
                        this.logs = [];
                    },
                    toggleAutoScroll() {
                        this.autoScroll = !this.autoScroll;
                    },
                    formatTime(timestamp) {
                        return new Date(timestamp).toLocaleTimeString();
                    },
                    getLogClass(level) {
                        switch (level) {
                            case 'ERROR': return 'text-red-400';
                            case 'WARN': return 'text-yellow-400';
                            case 'INFO': return 'text-blue-400';
                            case 'DEBUG': return 'text-green-400';
                            default: return 'text-white';
                        }
                    },
                    getServiceClass(service) {
                        switch (service) {
                            case 'CDN': return 'text-blue-400';
                            case 'PROXY': return 'text-purple-400';
                            default: return 'text-gray-400';
                        }
                    },
                    getLevelClass(level) {
                        switch (level) {
                            case 'ERROR': return 'text-red-400';
                            case 'WARN': return 'text-yellow-400';
                            case 'INFO': return 'text-blue-400';
                            case 'DEBUG': return 'text-green-400';
                            default: return 'text-gray-400';
                        }
                    },
                    updatePacketDropConfig() {
                        this.ws.send(JSON.stringify({
                            type: 'packet_drop_config',
                            enabled: this.packetDropConfig.enabled,
                            dropRate: this.packetDropConfig.dropRate
                        }));
                    }
                }
            }).mount('#app');
        }
    </script>
</body>
</html>

